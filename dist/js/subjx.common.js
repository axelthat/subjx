/*@license
* Drag/Rotate/Resize Library
* Released under the MIT license, 2018-2021
* Karen Sarksyan
* nichollascarter@gmail.com
*/
"use strict";const t=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,1e3/60)},e=window.cancelAnimationFrame||window.mozCancelAnimationFrame||function(t){clearTimeout(t)},{forEach:s,slice:r,map:o,reduce:n}=Array.prototype,{warn:a}=console,i=t=>null!=t,c=t=>null==t,l=t=>"function"==typeof t,h=t=>l(t)?function(){t.call(this,...arguments)}:()=>{};class u{constructor(t){if("string"==typeof t){const e=document.querySelectorAll(t);this.length=e.length;for(let t=0;t<this.length;t++)this[t]=e[t]}else if("object"!=typeof t||1!==t.nodeType&&t!==document)if(t instanceof u){this.length=t.length;for(let e=0;e<this.length;e++)this[e]=t[e]}else{if(!i(e=t)||"object"!=typeof e||!(Array.isArray(e)||i(window.Symbol)&&"function"==typeof e[window.Symbol.iterator]||i(e.forEach)||"number"==typeof e.length&&(0===e.length||e.length>0&&e.length-1 in e)))throw new Error("Passed parameter must be selector/element/elementArray");this.length=t.length;for(let e=0;e<this.length;e++)1===t[e].nodeType&&(this[e]=t[e])}else this[0]=t,this.length=1;var e}css(t){const e={setStyle(t){return((t,e)=>{let s=t.length;for(;s--;)for(const r in e)t[s].style[r]=e[r];return t.style})(this,t)},getStyle(){return(e=>{let s=e.length;for(;s--;)return e[s].currentStyle?e[s].currentStyle[t]:document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e[s],"")[t]:e[s].style[t]})(this)}};return"string"==typeof t?e.getStyle.apply(this,r.call(arguments,1)):"object"!=typeof t&&t?(a(`Method ${t} does not exist`),!1):e.setStyle.apply(this,arguments)}on(){let t=this.length;for(;t--;)this[t].events||(this[t].events={},this[t].events[arguments[0]]=[]),"string"!=typeof arguments[1]?document.addEventListener?this[t].addEventListener(arguments[0],arguments[1],arguments[2]||{passive:!1}):document.attachEvent?this[t].attachEvent("on"+arguments[0],arguments[1]):this[t]["on"+arguments[0]]=arguments[1]:d(this[t],arguments[0],arguments[1],arguments[2],arguments[3],!0);return this}off(){let t=this.length;for(;t--;)this[t].events||(this[t].events={},this[t].events[arguments[0]]=[]),"string"!=typeof arguments[1]?document.removeEventListener?this[t].removeEventListener(arguments[0],arguments[1],arguments[2]):document.detachEvent?this[t].detachEvent("on"+arguments[0],arguments[1]):this[t]["on"+arguments[0]]=null:d(this[t],arguments[0],arguments[1],arguments[2],arguments[3],!1);return this}is(t){if(c(t))return!1;const e=p(t);let s=this.length;for(;s--;)if(this[s]===e[s])return!0;return!1}}function d(t,e,s,r,o,n){const a=function(t){let e=t.target;for(;e&&e!==this;)e.matches(s)&&r.call(e,t),e=e.parentNode};!0===n?document.addEventListener?t.addEventListener(e,a,o||{passive:!1}):document.attachEvent?t.attachEvent("on"+e,a):t["on"+e]=a:document.removeEventListener?t.removeEventListener(e,a,o||{passive:!1}):document.detachEvent?t.detachEvent("on"+e,a):t["on"+e]=null}function p(t){return new u(t)}const x=["","-webkit-","-moz-","-ms-","-o-"],f={NOTIFIER_EVENTS:["ongetstate","onapply","onmove","onresize","onrotate"],ON_GETSTATE:"ongetstate",ON_APPLY:"onapply",ON_MOVE:"onmove",ON_RESIZE:"onresize",ON_ROTATE:"onrotate"},y={EMITTER_EVENTS:["dragStart","drag",,"dragEnd","resizeStart","resize","resizeEnd","rotateStart","rotate","rotateEnd","setPointStart","setPointEnd"],E_DRAG_START:"dragStart",E_DRAG:"drag",E_DRAG_END:"dragEnd",E_RESIZE_START:"resizeStart",E_RESIZE:"resize",E_RESIZE_END:"resizeEnd",E_ROTATE_START:"rotateStart",E_ROTATE:"rotate",E_ROTATE_END:"rotateEnd",E_SET_POINT_START:"setPointStart",E_SET_POINT_END:"setPointEnd"},b={E_MOUSEDOWN:"mousedown",E_MOUSEUP:"mouseup",E_MOUSEMOVE:"mousemove",E_TOUCHSTART:"touchstart",E_TOUCHEND:"touchend",E_TOUCHMOVE:"touchmove"},m={TRANSFORM_HANDLES_KEYS:{TOP_LEFT:"tl",TOP_CENTER:"tc",TOP_RIGHT:"tr",BOTTOM_LEFT:"bl",BOTTOM_RIGHT:"br",BOTTOM_CENTER:"bc",MIDDLE_LEFT:"ml",MIDDLE_RIGHT:"mr",CENTER:"center"},TRANSFORM_EDGES_KEYS:{TOP_EDGE:"te",BOTTOM_EDGE:"be",LEFT_EDGE:"le",RIGHT_EDGE:"re"}},{ON_GETSTATE:_,ON_APPLY:g,ON_MOVE:E,ON_RESIZE:v,ON_ROTATE:M}=f;class T{constructor(){this.observers={}}subscribe(t,e){const s=this.observers;return c(s[t])&&Object.defineProperty(s,t,{value:[]}),s[t].push(e),this}unsubscribe(t,e){const s=this.observers;if(i(s[t])){const r=s[t].indexOf(e);s[t].splice(r,1)}return this}notify(t,e,s){c(this.observers[t])||this.observers[t].forEach(r=>{if(e!==r)switch(t){case E:r.notifyMove(s);break;case M:r.notifyRotate(s);break;case v:r.notifyResize(s);break;case g:r.notifyApply(s);break;case _:r.notifyGetState(s)}})}}class w{constructor(t){this.name=t,this.callbacks=[]}registerCallback(t){this.callbacks.push(t)}removeCallback(t){const e=this.callbacks(t);this.callbacks.splice(e,1)}}class O{constructor(){this.events={}}registerEvent(t){this.events[t]=new w(t)}emit(t,e,s){this.events[e].callbacks.forEach(e=>{e.call(t,s)})}addEventListener(t,e){this.events[t].registerCallback(e)}removeEventListener(t,e){this.events[t].removeCallback(e)}}const{E_DRAG:S}=y,{E_MOUSEMOVE:R,E_MOUSEUP:N,E_TOUCHMOVE:A,E_TOUCHEND:k}=b;class D{constructor(t){this.el=t,this.storage=null,this.proxyMethods=null,this.eventDispatcher=new O,this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onTouchMove=this._onTouchMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._animate=this._animate.bind(this)}enable(t){this._processOptions(t),this._init(this.el),this.proxyMethods.onInit.call(this,this.el)}disable(){V()}_init(){V()}_destroy(){V()}_processOptions(){V()}_start(){V()}_moving(){V()}_end(){V()}_animate(){V()}_drag({dx:t,dy:e,...s}){const r={dx:t,dy:e,transform:this._processMove(t,e),...s};this.proxyMethods.onMove.call(this,r),this._emitEvent(S,r)}_draw(){this._animate()}_onMouseDown(t){this._start(t),p(document).on(R,this._onMouseMove).on(N,this._onMouseUp)}_onTouchStart(t){this._start(t.touches[0]),p(document).on(A,this._onTouchMove).on(k,this._onTouchEnd)}_onMouseMove(t){t.preventDefault&&t.preventDefault(),this._moving(t,this.el)}_onTouchMove(t){t.preventDefault&&t.preventDefault(),this._moving(t.touches[0],this.el)}_onMouseUp(t){p(document).off(R,this._onMouseMove).off(N,this._onMouseUp),this._end(t,this.el)}_onTouchEnd(t){p(document).off(A,this._onTouchMove).off(k,this._onTouchEnd),0===t.touches.length&&this._end(t.changedTouches[0],this.el)}_emitEvent(){this.eventDispatcher.emit(this,...arguments)}on(t,e){return this.eventDispatcher.addEventListener(t,e),this}off(t,e){return this.eventDispatcher.removeEventListener(t,e),this}}const V=()=>{throw Error("Method not implemented")},C=Math.PI/180,Y=(t,e)=>{if(0===e)return t;{const s=((t,e)=>0===e?t:Math.round(t/e)*e)(t,e);if(s-t<e)return s}},j=(t,e=6)=>Number(t.toFixed(e)),P=(t,e)=>{const s=t.map(t=>t[e]);return[Math.min(...s),Math.max(...s)]},X=t=>t.getBoundingClientRect(),H=(t,e)=>{if(e){if(t.classList){if(!(e.indexOf(" ")>-1))return t.classList.add(e);e.split(/\s+/).forEach(e=>t.classList.add(e))}return t}},L=(t,e)=>{if(e){if(t.classList){if(!(e.indexOf(" ")>-1))return t.classList.remove(e);e.split(/\s+/).forEach(e=>t.classList.remove(e))}return t}},z=t=>{const e=`matrix3d(${t.join()})`;return{transform:e,webkitTranform:e,mozTransform:e,msTransform:e,otransform:e}},I=(t,e)=>{const s=window.getComputedStyle(t);let r=null;for(const t of x)if(r=s.getPropertyValue(`${t}${e}`)||r,r)break;return r},{NOTIFIER_EVENTS:B,ON_GETSTATE:G,ON_APPLY:U,ON_MOVE:F,ON_RESIZE:W,ON_ROTATE:$}=f,{EMITTER_EVENTS:q,E_DRAG_START:Z,E_DRAG:K,E_DRAG_END:Q,E_RESIZE_START:J,E_RESIZE:tt,E_RESIZE_END:et,E_ROTATE_START:st,E_ROTATE:rt,E_ROTATE_END:ot}=y,{TRANSFORM_HANDLES_KEYS:nt,TRANSFORM_EDGES_KEYS:at}=m,{E_MOUSEDOWN:it,E_TOUCHSTART:ct,E_MOUSEMOVE:lt,E_MOUSEUP:ht,E_TOUCHMOVE:ut,E_TOUCHEND:dt}=b,{TOP_LEFT:pt,TOP_CENTER:xt,TOP_RIGHT:ft,BOTTOM_LEFT:yt,BOTTOM_RIGHT:bt,BOTTOM_CENTER:mt,MIDDLE_LEFT:_t,MIDDLE_RIGHT:gt}=nt,{TOP_EDGE:Et,BOTTOM_EDGE:vt,LEFT_EDGE:Mt,RIGHT_EDGE:Tt}=at;class wt extends D{constructor(t,e,s){if(super(t),this.constructor===wt)throw new TypeError("Cannot construct Transformable instances directly");this.observable=s,q.forEach(t=>this.eventDispatcher.registerEvent(t)),this.enable(e)}_cursorPoint(){throw Error("'_cursorPoint()' method not implemented")}_rotate({radians:t,...e}){const s={transform:this._processRotate(t),delta:t,...e};this.proxyMethods.onRotate.call(this,s),this._emitEvent(rt,s)}_resize({dx:t,dy:e,...s}){const r={...this._processResize(t,e),dx:t,dy:e,...s};this.proxyMethods.onResize.call(this,r),this._emitEvent(tt,r)}_processOptions(t={}){const{el:e}=this;H(e,"sjx-drag");const{each:s={move:!1,resize:!1,rotate:!1},snap:r={x:10,y:10,angle:10},axis:o="xy",cursorMove:n="auto",cursorResize:a="auto",cursorRotate:i="auto",rotationPoint:c=!1,restrict:l,draggable:u=!0,resizable:d=!0,rotatable:x=!0,scalable:f=!1,applyTranslate:y=!1,onInit:b=(()=>{}),onDrop:m=(()=>{}),onMove:_=(()=>{}),onResize:g=(()=>{}),onRotate:E=(()=>{}),onDestroy:v=(()=>{}),container:M=e.parentNode,controlsContainer:T=M,proportions:w=!1,rotatorAnchor:O=null,rotatorOffset:S=50,showNormal:R=!0,custom:N}=t;this.options={axis:o,cursorMove:n,cursorRotate:i,cursorResize:a,rotationPoint:c,restrict:l?p(l)[0]||document.body:null,container:p(M)[0],controlsContainer:p(T)[0],snap:{...r,angle:r.angle*C},each:s,proportions:w,draggable:u,resizable:d,rotatable:x,scalable:f,applyTranslate:y,custom:"object"==typeof N&&N||null,rotatorAnchor:O,rotatorOffset:S,showNormal:R},this.proxyMethods={onInit:h(b),onDrop:h(m),onMove:h(_),onResize:h(g),onRotate:h(E),onDestroy:h(v)},this.subscribe(s)}_animate(){const e=this,{observable:s,storage:r,options:o}=e;if(c(r))return;if(r.frame=t(e._animate),!r.doDraw)return;r.doDraw=!1;let{dox:n,doy:a,clientX:i,clientY:l,doDrag:h,doResize:u,doRotate:d,doSetCenter:p,revX:x,revY:f}=r;const{snap:y,each:{move:b,resize:m,rotate:_},draggable:g,resizable:E,rotatable:v}=o;if(u&&E){const{transform:{scX:t,scY:o},cx:c,cy:h}=r,{x:u,y:d}=this._pointToElement({x:i,y:l});let p=n?Y(u-c,y.x/t):0,b=a?Y(d-h,y.y/o):0;p=n?x?-p:p:0,b=a?f?-b:b:0;const _={dx:p,dy:b,clientX:i,clientY:l};e._resize(_),m&&s.notify(W,e,_)}if(h&&g){const{nx:t,ny:o}=r,c={dx:n?Y(i-t,y.x):0,dy:a?Y(l-o,y.y):0,clientX:i,clientY:l};e._drag(c),b&&s.notify(F,e,c)}if(d&&v){const{pressang:t,center:o}=r,n=Math.atan2(l-o.y,i-o.x)-t,a={clientX:i,clientY:l};e._rotate({radians:Y(n,y.angle),...a}),_&&s.notify($,e,{radians:n,...a})}if(p&&v){const{bx:t,by:s}=r,{x:o,y:n}=this._pointToControls({x:i,y:l});e._moveCenterHandle(o-t,n-s)}}_start(t){const{clientX:e,clientY:s}=t,{observable:r,storage:o,storage:{handles:n},options:{axis:a,each:c},el:l}=this,h=Object.values(n).some(e=>p(t.target).is(e))||l.contains(t.target);if(o.isTarget=h,!h)return;const u=this._compute(t,l);Object.keys(u).map(t=>o[t]=u[t]);const{onRightEdge:d,onBottomEdge:x,onTopEdge:f,onLeftEdge:y,handle:b,factor:m,revX:_,revY:g,doW:E,doH:v}=u,M=d||x||f||y,{rotator:T,center:w,radius:O}=n;i(O)&&L(O,"sjx-hidden");const S=b.is(T),R=!!i(w)&&b.is(w),N=l.contains(t.target)&&!(S||M||R),{x:A,y:k}=this._cursorPoint({clientX:e,clientY:s}),{x:D,y:V}=this._pointToElement({x:A,y:k}),{x:C,y:Y}=this._pointToControls({x:A,y:k}),j={clientX:e,clientY:s,cx:D,cy:V,nx:A,ny:k,bx:C,by:Y,doResize:M,doDrag:N,doRotate:S,doSetCenter:R,onExecution:!0,cursor:null,dox:/\x/.test(a)&&(!M||(b.is(n.ml)||b.is(n.mr)||b.is(n.tl)||b.is(n.tr)||b.is(n.bl)||b.is(n.br)||b.is(n.le)||b.is(n.re))),doy:/\y/.test(a)&&(!M||(b.is(n.br)||b.is(n.bl)||b.is(n.bc)||b.is(n.tr)||b.is(n.tl)||b.is(n.tc)||b.is(n.te)||b.is(n.be))),cached:{}};this.storage={...o,...j};const P={clientX:e,clientY:s};M?this._emitEvent(J,P):S?this._emitEvent(st,P):N&&this._emitEvent(Z,P);const{move:X,resize:H,rotate:z}=c,I=M?tt:S?rt:K,B=M&&H||S&&z||N&&X;r.notify(G,this,{clientX:e,clientY:s,actionName:I,triggerEvent:B,factor:m,revX:_,revY:g,doW:E,doH:v}),this._draw()}_moving(t){const{storage:e={},options:s}=this;if(!e.isTarget)return;const{x:r,y:o}=this._cursorPoint(t);e.e=t,e.clientX=r,e.clientY=o,e.doDraw=!0;let{doRotate:n,doDrag:a,doResize:i,cursor:l}=e;const{cursorMove:h,cursorResize:u,cursorRotate:d}=s;c(l)&&(a?l=h:n?l=d:i&&(l=u),p(document.body).css({cursor:l}))}_end({clientX:t,clientY:s}){const{options:{each:r},observable:o,storage:n,storage:{doResize:a,doDrag:c,doRotate:l,frame:h,handles:{radius:u},isTarget:d},proxyMethods:x}=this;if(!d)return;const f=a?tt:c?K:rt;n.doResize=!1,n.doDrag=!1,n.doRotate=!1,n.doSetCenter=!1,n.doDraw=!1,n.onExecution=!1,n.cursor=null,this._apply(f);const y={clientX:t,clientY:s};x.onDrop.call(this,y),a?this._emitEvent(et,y):l?this._emitEvent(ot,y):c&&this._emitEvent(Q,y);const{move:b,resize:m,rotate:_}=r,g=a&&m||l&&_||c&&b;o.notify(U,this,{clientX:t,clientY:s,actionName:f,triggerEvent:g}),e(h),p(document.body).css({cursor:"auto"}),i(u)&&H(u,"sjx-hidden")}_compute(t,e){const{handles:s}=this.storage,r=p(t.target),{revX:o,revY:n,doW:a,doH:i,...c}=this._checkHandles(r,s),l=this._getState({revX:o,revY:n,doW:a,doH:i}),{x:h,y:u}=this._cursorPoint(t),d=Math.atan2(u-l.center.y,h-l.center.x);return{...l,...c,handle:Object.values(s).some(e=>p(t.target).is(e))?r:p(e),pressang:d}}_checkHandles(t,e){const s=s=>s.some(s=>{return r=e[s],!!i(r)&&t.is(r);var r});return{revX:s([pt,_t,yt,xt,Mt]),revY:s([pt,ft,xt,_t,Et]),onTopEdge:s([xt,ft,pt,Et]),onLeftEdge:s([pt,_t,yt,Mt]),onRightEdge:s([ft,gt,bt,Tt]),onBottomEdge:s([bt,mt,yt,vt]),doW:s([_t,gt,Mt,Tt]),doH:s([xt,mt,vt,Et])}}_destroy(){const{el:t,storage:{controls:e,wrapper:s}}=this;[t,e].map(t=>p(t).off(it,this._onMouseDown).off(ct,this._onTouchStart)),s.parentNode.removeChild(s)}notifyMove(){this._drag(...arguments)}notifyRotate({radians:t,...e}){const{snap:{angle:s}}=this.options;this._rotate({radians:Y(t,s),...e})}notifyResize(){this._resize(...arguments)}notifyApply({clientX:t,clientY:e,actionName:s,triggerEvent:r}){this.proxyMethods.onDrop.call(this,{clientX:t,clientY:e}),r&&(this._apply(s),this._emitEvent(s+"End",{clientX:t,clientY:e}))}notifyGetState({clientX:t,clientY:e,actionName:s,triggerEvent:r,...o}){if(r){const r=this._getState(o);this.storage={...this.storage,...r},this._emitEvent(s+"Start",{clientX:t,clientY:e})}}subscribe({resize:t,move:e,rotate:s}){const{observable:r}=this;(e||t||s)&&r.subscribe(G,this).subscribe(U,this),e&&r.subscribe(F,this),t&&r.subscribe(W,this),s&&r.subscribe($,this)}unsubscribe(){const{observable:t}=this;B.map(e=>t.unsubscribe(e,this))}disable(){const{storage:t,proxyMethods:e,el:s}=this;c(t)||(t.onExecution&&p(document).off(lt,this._onMouseMove).off(ht,this._onMouseUp).off(ut,this._onTouchMove).off(dt,this._onTouchEnd),L(s,"sjx-drag"),this.unsubscribe(),this._destroy(),e.onDestroy.call(this,s),delete this.storage)}exeDrag({dx:t,dy:e}){const{draggable:s}=this.options;s&&(this.storage={...this.storage,...this._getState({revX:!1,revY:!1,doW:!1,doH:!1})},this._drag({dx:t,dy:e}),this._apply(K))}exeResize({dx:t,dy:e,revX:s=!1,revY:r=!1,doW:o=!1,doH:n=!1}){const{resizable:a}=this.options;a&&(this.storage={...this.storage,...this._getState({revX:s,revY:r,doW:o,doH:n})},this._resize({dx:t,dy:e}),this._apply(tt))}exeRotate({delta:t}){const{rotatable:e}=this.options;e&&(this.storage={...this.storage,...this._getState({revX:!1,revY:!1,doW:!1,doH:!1})},this._rotate({radians:t}),this._apply(rt))}}const Ot=t=>t.map(t=>[...t]),St=t=>t.reduce((e,s,r)=>[...e,t[0][r],t[1][r],t[2][r],t[3][r]],[]),Rt=(t=4)=>[...Array(t)].map((t,e,s)=>s.map(()=>+!e--)),Nt=(t,e,s=0)=>Rt().map((r,o)=>(r[3]=[t,e,s,1][o],r)),At=(t,e=!0)=>{const s=e?Ot(t):t;return s[0][3]=s[1][3]=s[2][3]=0,s},kt=(t,e)=>{const s=[];for(let r=0,o=t.length;r<o;++r){let n=0;for(let s=0;s<o;++s)n+=+t[r][s]*e[s];s[r]=n}return s},Dt=(t,e)=>{const s=[];for(let r=0;r<e.length;r++){s[r]=[];for(let o=0;o<t[0].length;o++){let n=0;for(let s=0;s<t.length;s++)n+=t[s][o]*e[r][s];s[r].push(n)}}return s},Vt=t=>{const e=Ot(t);let s,r=e.length,o=[];for(let t=0;t<r;t++)o[t]=[];for(let t=0;t<r;t++)for(let e=0;e<r;e++)o[t][e]=0,t==e&&(o[t][e]=1);for(let t=0;t<r;t++){s=e[t][t];for(let n=0;n<r;n++)e[t][n]/=s,o[t][n]/=s;for(let n=t+1;n<r;n++){s=e[n][t];for(let a=0;a<r;a++)e[n][a]-=e[t][a]*s,o[n][a]-=o[t][a]*s}}for(let t=r-1;t>0;t--)for(let n=t-1;n>=0;n--){s=e[n][t];for(let a=0;a<r;a++)e[n][a]-=e[t][a]*s,o[n][a]-=o[t][a]*s}for(let t=0;t<r;t++)for(let s=0;s<r;s++)e[t][s]=o[t][s];return e},Ct=(t,[e,s,r])=>{const o=Nt(-e,-s,-r),n=Nt(e,s,r);return Dt(Dt(o,t),n)},Yt=(t,e=document.body,s)=>{let r=Rt(),o=t,n=s||Pt(o),a=!1;for(;o&&o instanceof Element;){const t=Xt(o,a);if(r=Dt(r,Ct(n,t)),a=!0,o===e||null===o.offsetParent)break;o=o.offsetParent,n=Pt(o)}return r},jt=t=>{const e=Math.sqrt(t[0][0]*t[0][0]+t[1][0]*t[1][0]+t[2][0]*t[2][0]),s=Math.sqrt(t[0][1]*t[0][1]+t[1][1]*t[1][1]+t[2][1]*t[2][1]),r=Math.sqrt(t[0][2]*t[0][2]+t[1][2]*t[1][2]+t[2][2]*t[2][2]);let o=Math.atan2(-t[0][3]/r,t[1][3]/r),n=Math.asin(t[3][1]/r),a=Math.atan2(-t[3][0]/s,t[0][0]/e);return 1!==t[0][1]&&-1!==t[0][1]||(o=0,n=t[0][1]*-Math.PI/2,a=t[0][1]*Math.atan2(t[1][1]/s,t[0][1]/s)),{rotate:{x:o,y:n,z:a},translate:{x:t[0][3]/e,y:t[1][3]/s,z:t[2][3]/r},scale:{sX:e,sY:s,sZ:r}}},Pt=t=>{const e=I(t,"transform")||"none",s=Rt();if("none"===e)return s;const r=e.split(/\s*[(),]\s*/).slice(1,-1);if(16!==r.length)return[[+r[0],+r[2],0,+r[4]],[+r[1],+r[3],0,+r[5]],[0,0,1,0],[0,0,0,1]];for(let t=0;t<4;++t)for(let e=0;e<4;++e)s[e][t]=+r[4*t+e];return s},Xt=(t,e)=>{const s=I(t,"transform-origin"),r=s?s.split(" "):[],o=[e?-t.clientLeft:0,e?-t.clientTop:0,0,1];for(let t=0;t<r.length;++t)o[t]+=parseFloat(r[t]);return o},Ht=(t,e=document.body)=>{let s=0,r=0,o=!1;for(;t;){const n=Yt(t.offsetParent),[a,i]=kt(At(n,!1),[t.offsetLeft+(o?t.clientLeft:0),t.offsetTop+(o?t.clientTop:0),0,1]);if(r+=a,s+=i,e===t)break;o=!0,t=t.offsetParent}return[r,s,0,1]},{E_MOUSEDOWN:Lt,E_TOUCHSTART:zt}=b;class It extends wt{_init(t){const{rotationPoint:e,container:s,controlsContainer:r,resizable:o,rotatable:n,showNormal:a,rotatorOffset:l,rotatorAnchor:h}=this.options,{offsetHeight:u,offsetWidth:d}=t,x=$t(["sjx-wrapper"]),f=$t(["sjx-controls"]),y={},b=Yt(t,s),[m,_]=Ht(t,s),g=["data-sjx-cx","data-sjx-cy"].map(e=>{const s=t.getAttribute(e);return i(s)?Number(s):void 0}),E=g.every(t=>!isNaN(t)),v={tl:[0,0,0,1],bl:[0,u,0,1],br:[d,u,0,1],tr:[d,0,0,1],tc:[d/2,0,0,1],ml:[0,u/2,0,1],bc:[d/2,u,0,1],mr:[d,u/2,0,1],center:[d/2,u/2,0,1]},M=Object.entries(v).reduce((t,[e,s])=>[...t,[e,kt(b,s)]],[]).reduce((t,[e,[s,r,o,n]])=>(t[e]=[s+m,r+_,o,n],t),{});let T={},w=null;if(n){const t={};let s=1;switch(h){case"n":t.x=M.tc[0],t.y=M.tc[1];break;case"s":t.x=M.bc[0],t.y=M.bc[1],s=-1;break;case"w":t.x=M.ml[0],t.y=M.ml[1],s=-1;break;case"e":default:t.x=M.mr[0],t.y=M.mr[1]}const r="n"===h||"s"===h?Math.atan2(M.bl[1]-M.tl[1],M.bl[0]-M.tl[0]):Math.atan2(M.tl[1]-M.tr[1],M.tl[0]-M.tr[0]);w=[t.x-l*s*Math.cos(r),t.y-l*s*Math.sin(r)];const o=a?Gt([[t.x,t.y],w],"normal"):null;a&&f.appendChild(o);let n=null;e&&(n=Gt([M.center,M.center],"radius"),H(n,"sjx-hidden"),f.appendChild(n)),T={...T,normal:o,radius:n}}const O={te:[M.tl,M.tr],be:[M.bl,M.br],le:[M.tl,M.bl],re:[M.tr,M.br]},S=o?{tl:M.tl,tr:M.tr,br:M.br,bl:M.bl,tc:M.tc,bc:M.bc,ml:M.ml,mr:M.mr}:{},R=E?[...g,0,1]:M.center,N={...S,center:e&&n?R:void 0,rotator:w},A=(t,e)=>Object.keys(t).map(s=>{const r=t[s];if(c(r))return;const o=e(r,s);y[s]=o,f.appendChild(o)});A(O,Gt),A(N,Bt),x.appendChild(f),r.appendChild(x),this.storage={wrapper:x,controls:f,handles:{...y,...T},parent:t.parentNode,center:{isShifted:E},cached:{}},[t,f].map(t=>p(t).on(Lt,this._onMouseDown).on(zt,this._onTouchStart))}_pointToElement({x:t,y:e}){const{transform:{ctm:s}}=this.storage,r=Vt(s);return this._applyMatrixToPoint(At(r,!1),t,e)}_pointToControls({x:t,y:e}){const{transform:{wrapperMatrix:s}}=this.storage,r=Vt(s);return this._applyMatrixToPoint(At(r,!1),t,e)}_applyMatrixToPoint(t,e,s){const[r,o]=kt(t,[e,s,0,1]);return{x:r,y:o}}_cursorPoint({clientX:t,clientY:e}){const{container:s}=this.options,r=Yt(s);return this._applyMatrixToPoint(Vt(r),t,e)}_restrictHandler(t){const{storage:{transform:{containerMatrix:e}},options:{restrict:s,container:r}}=this;let o=null,n=null;const a=Wt(s,r,e),i=this.getBoundingRect(t),[c,l]=P(a,0),[h,u]=P(a,1);for(let t=0,e=i.length;t<e;t++){const[e,s]=i[t];(e<c||e>l)&&(o=e),(s<h||s>u)&&(n=s)}return{x:o,y:n}}_apply(){const{el:t,storage:{cached:e,controls:s,transform:{matrix:r},center:o},options:{applyTranslate:n}}=this,a=p(s);if(!c(e)){if(t.setAttribute("data-sjx-cx",o.elX),t.setAttribute("data-sjx-cy",o.elY),n){const s=p(t),{dx:o,dy:n}=e,i=z(r),c=parseFloat(t.style.left||s.css("left")),l=parseFloat(t.style.top||s.css("top"));i.left=c+o+"px",i.top=l+n+"px",s.css(i),a.css(i)}this.storage.cached={}}}_processResize(t,e){const{el:s,storage:r,storage:{transform:{matrix:o,auxiliary:{scale:{translateMatrix:n}}},cached:{dist:{dx:a=t,dy:i=e}={}}={},box:{width:c,height:l},revX:h,revY:u,doW:d,doH:x},options:{proportions:f,scalable:y,restrict:b}}=this,m=(t,e)=>{const s=d||!d&&!x?(c+t)/c:(l+e)/l,r=f?c*s:c+t,o=f?l*s:l+e;return[r/c,o/l,r,o]},_=(t,e)=>{const s=((t,e,s=1,r=1)=>Rt().map((o,n)=>(o[n]=[t,e,s,r][n],o)))(t,e);return Dt(Dt(n,s),Vt(n))},g=(t,e)=>{const s=t[0][3],r=t[1][3],o=Nt(s,r),n=Nt(s*(h?-1:1),r*(u?-1:1));return Dt(Dt(n,e),Vt(o))},[E,v,M,T]=m(t,e),w=_(E,v),O=y?Dt(w,o):g(w,o);this.storage.cached.box={width:M,height:T};const{x:S,y:R}=b?this._restrictHandler(O):{x:null,y:null},N=(null!==S||null!==R)&&b,A=N?a:t,k=N?i:e,[D,V,C,Y]=m(A,k);if(Math.abs(C)<=2||Math.abs(Y)<=2)return;const j=_(D,V),P=y?Dt(j,o):g(j,o);return p(s).css({...z(St(P)),...!y&&{width:C+"px",height:Y+"px"}}),Ft(r,this.options,{el:s,boxMatrix:P}),r.cached.dist={dx:A,dy:k},{transform:P,width:C,height:Y}}_processMove(t,e){const{el:s,storage:r,storage:{wrapper:o,transform:{matrix:n,wrapperMatrix:a,auxiliary:{translate:{parentMatrix:i}}},center:c,cached:{dist:{dx:l=t,dy:h=e}={}}={}},options:{restrict:u}}=this,[d,x]=kt(i,[t,e,0,1]),f=Dt(n,Nt(d,x)),{x:y,y:b}=u?this._restrictHandler(f):{x:null,y:null},m=null!==y&&u?l:t,_=null!==b&&u?h:e,[g,E]=kt(i,[m,_,0,1]),v=Dt(n,Nt(g,E)),M=Dt(a,Nt(m,_)),T=z(St(v)),w=z(St(M));return p(s).css(T),p(o).css(w),r.cached.dist={dx:m,dy:_},c.isShifted,v}_processRotate(t){const{el:e,storage:{transform:{matrix:s,auxiliary:{rotate:{translateMatrix:r}}}},options:{restrict:o}}=this,n=j(Math.cos(t),4),a=((t,e)=>{const s=Rt();return s[0][0]=e,s[0][1]=-t,s[1][0]=t,s[1][1]=e,s})(j(Math.sin(t),4),n),c=Dt(Dt(Vt(r),a),r),l=Dt(s,c),{x:h,y:u}=o?this._restrictHandler(l):{x:null,y:null};return i(h)||i(u)||(p(e).css(z(St(l))),Ft(this.storage,this.options,{el:e,boxMatrix:l})),l}_getState({revX:t,revY:e,doW:s,doH:r}){const{el:o,storage:{handles:{center:n},parent:a,wrapper:i,center:c},options:{container:l,restrict:h,scalable:u}}=this,{offsetWidth:d,offsetHeight:p}=h||l,[x,f]=Ht(o,l),{offsetLeft:y,offsetTop:b,offsetWidth:m,offsetHeight:_}=o,g=Pt(o),E=Yt(o,l),v=Yt(a,l),M=Yt(i,l),T=h?Yt(h,h.parentNode):Yt(l,l.parentNode),w=m/2,O=_/2,S=r?0:t?-w:w,R=s?0:e?-O:O,[N,A]=kt(E,[w,O,0,1]),k=N+x,D=A+f,V=n?Pt(n):Rt(),{translate:{x:C,y:Y}}=n?jt(Yt(n)):{translate:{x:k,y:D}},[j,P]=kt(Dt(Vt(At(E)),At(V)),[C-k,Y-D,0,1]),[X,H]=kt(g,[j,P,0,1]),L=kt(At(T),[d,p,0,1]),{scale:{sX:z,sY:I}}=jt(Yt(o,o.parentNode));return{transform:{auxiliary:{scale:{translateMatrix:u?Nt(S,R):Nt(r?0:w,s?0:O)},translate:{parentMatrix:Vt(At(v))},rotate:{translateMatrix:Nt(X,H)}},scaleX:S,scaleY:R,matrix:g,ctm:E,parentMatrix:v,containerMatrix:T,wrapperMatrix:M,scX:z,scY:I,containerBox:L},box:{width:m,height:_,left:y,top:b,offset:{left:x,top:f}},center:{...c,x:k,y:D,elX:X,elY:H,matrix:V},revX:t,revY:e,doW:s,doH:r}}_moveCenterHandle(t,e){const{storage:{handles:{center:s},center:{matrix:r}}}=this,o=Dt(r,Nt(t,e));p(s).css({...z(St(o))}),this.storage.center.isShifted=!0}resetCenterPoint(){const{el:t,el:{offsetHeight:e,offsetWidth:s},storage:{wrapper:r,handles:{center:o}},options:{container:n}}=this;if(!o)return;const[a,i]=Ht(t,n),c=Dt(Yt(t,n),Vt(Yt(r,r.parentNode))),[l,h]=kt(c,[s/2,e/2,0,1]);p(o).css({transform:`translate(${l+a}px, ${h+i}px)`})}fitControlsToSize(){const{el:t,storage:{wrapper:e}}=this;e.removeAttribute("transform"),Ft(this.storage,this.options,{el:t})}getBoundingRect(t=null){const{el:e,options:{scalable:s,restrict:r},storage:{box:o,box:{width:n,height:a},cached:{box:{width:i=n,height:c=a}={}}={}}}=this,l=s?o:{...o,width:i,height:c};return Wt(e,r,Yt(e,r,t),l)}get controls(){return this.storage.wrapper}}const Bt=([t,e],s="handler",r={})=>{const o=$t(["sjx-hdl","sjx-hdl-"+s]);return p(o).css({transform:`translate(${t}px, ${e}px)`,...r}),o},Gt=([t,e,s=1],r)=>{const{cx:o,cy:n,length:a,theta:i}=Ut(t,e,s),c=$t(["sjx-hdl-line","sjx-hdl-"+r]);return p(c).css({transform:`translate(${o}px, ${n}px) rotate(${i}deg)`,height:s+"px",width:a+"px"}),c},Ut=(t,e,s=1)=>{const[r,o]=t,[n,a]=e,i=Math.sqrt((n-r)*(n-r)+(a-o)*(a-o));return{cx:(r+n)/2-i/2,cy:(o+a)/2-s/2,thickness:s,theta:Math.atan2(o-a,r-n)*(180/Math.PI),length:i}},Ft=(t,e,s)=>{const{wrapper:r,handles:o,transform:{wrapperMatrix:n=Yt(r,r.parentNode)}={},center:a}=t,{rotationPoint:i,rotatable:c,resizable:l,showNormal:h,rotatorOffset:u,rotatorAnchor:d,container:x}=e,{el:f,el:{offsetHeight:y,offsetWidth:b}}=s,[m,_]=Ht(f,x),g=Dt(Yt(f,x),Vt(n)),E={tl:[0,0,0,1],tr:[b,0,0,1],bl:[0,y,0,1],br:[b,y,0,1],tc:[b/2,0,0,1],ml:[0,y/2,0,1],bc:[b/2,y,0,1],mr:[b,y/2,0,1],...i&&c&&!a.isShifted&&{center:[b/2,y/2,0,1]}},v=Object.entries(E).reduce((t,[e,s])=>[...t,[e,kt(g,s)]],[]).reduce((t,[e,[s,r,o,n]])=>(t[e]=[s+m,r+_,o,n],t),{});let M=null,T={};if(c){const t={};let e=1,s=[];switch(d){case"n":t.x=v.tc[0],t.y=v.tc[1];break;case"s":t.x=v.bc[0],t.y=v.bc[1],e=-1;break;case"w":t.x=v.ml[0],t.y=v.ml[1],e=-1;break;case"e":default:t.x=v.mr[0],t.y=v.mr[1]}const r="n"===d||"s"===d?Math.atan2(v.bl[1]-v.tl[1],v.bl[0]-v.tl[0]):Math.atan2(v.tl[1]-v.tr[1],v.tl[0]-v.tr[0]),o=u*e;s=[t.x-o*Math.cos(r),t.y-o*Math.sin(r)],M=h?[[t.x,t.y],s]:null,T={rotator:s}}const w={...v},O={te:[v.tl,v.tr],be:[v.bl,v.br],le:[v.tl,v.bl],re:[v.tr,v.br],...h&&M&&{normal:M}};Object.keys(O).forEach(t=>{const[e,s]=O[t],{cx:r,cy:n,length:a,theta:i}=Ut(e,s);p(o[t]).css({transform:`translate(${r}px, ${n}px) rotate(${i}deg)`,width:a+"px"})});const S={...l&&w,...T};Object.keys(S).forEach(t=>{const e=S[t];if(!e)return;const[s,r]=e;p(o[t]).css({transform:`translate(${s}px, ${r}px)`})})},Wt=(t,e,s,r)=>{const[o,n]=Ht(t,e),{width:a,height:i,offset:{left:c,top:l}}=r||{width:t.offsetWidth,height:t.offsetHeight,offset:{left:o,top:n}};return[[0,0,0,1],[a,0,0,1],[0,i,0,1],[a,i,0,1]].reduce((t,e)=>[...t,kt(s,e)],[]).map(([t,e,s,r])=>[t+c,e+l,s,r])},$t=(t=[])=>{const e=document.createElement("div");return t.forEach(t=>H(e,t)),e},qt=Qt("svg").createSVGPoint(),Zt=/\s*,\s*|\s+/g,Kt=["circle","ellipse","image","line","path","polygon","polyline","rect","text","g","foreignobject","use"];function Qt(t,e=[]){const s=document.createElementNS("http://www.w3.org/2000/svg",t);return e.forEach(t=>H(s,t)),s}const Jt=t=>{const e=[];return ae(t)?s.call(t.childNodes,t=>{if(1===t.nodeType){const s=t.tagName.toLowerCase();-1!==Kt.indexOf(s)&&("g"===s&&e.push(...Jt(t)),e.push(t))}}):e.push(t),e},te=()=>Qt("svg").createSVGMatrix(),ee=(t,e)=>{const s=te();return s.e=t,s.f=e,s},se=(t,e)=>(e.getScreenCTM&&e.getScreenCTM()||te()).inverse().multiply(t.getScreenCTM()||te()),re=t=>{const{a:e,b:s,c:r,d:o,e:n,f:a}=t;return`matrix(${e},${s},${r},${o},${n},${a})`},oe=(t,e,s)=>(qt.x=e,qt.y=s,qt.matrixTransform(t)),ne=t=>{const e=te();return e.a=t.a,e.b=t.b,e.c=t.c,e.d=t.d,e.e=t.e,e.f=t.f,e},ae=t=>"g"===t.tagName.toLowerCase(),ie=(t="")=>t.replace(/([^e])-/g,"$1 -").replace(/ +/g," "),ce=t=>ie(t).split(Zt).reduce((t,e,s,r)=>(s%2==0&&t.push(r.slice(s,s+2)),t),[]),le=/\s*([achlmqstvz])([^achlmqstvz]*)\s*/gi,he=t=>{let e=le.lastIndex=0;const s=[];for(;e=le.exec(t);){const[,t,r]=e,o=t.toUpperCase(),n=ie(r);s.push({relative:t!==o,key:o,cmd:t,values:n.trim().split(Zt).map(t=>{if(!isNaN(t))return Number(t)})})}return s},ue=t=>{const{path:e,dx:s,dy:r}=t;try{const t=he(e);let o="",n=" ",a=!0;for(let e=0,i=t.length;e<i;e++){const i=t[e],{values:c,key:l,relative:h}=i,u=[];switch(l){case"M":for(let t=0,e=c.length;t<e;t+=2){let[e,o]=c.slice(t,t+2);h&&!a||(e+=s,o+=r),u.push(e,o),a=!1}break;case"A":for(let t=0,e=c.length;t<e;t+=7){const e=c.slice(t,t+7);h||(e[5]+=s,e[6]+=r),u.push(...e)}break;case"C":for(let t=0,e=c.length;t<e;t+=6){const e=c.slice(t,t+6);h||(e[0]+=s,e[1]+=r,e[2]+=s,e[3]+=r,e[4]+=s,e[5]+=r),u.push(...e)}break;case"H":for(let t=0,e=c.length;t<e;t+=1){const e=c.slice(t,t+1);h||(e[0]+=s),u.push(e[0])}break;case"V":for(let t=0,e=c.length;t<e;t+=1){const e=c.slice(t,t+1);h||(e[0]+=r),u.push(e[0])}break;case"L":case"T":for(let t=0,e=c.length;t<e;t+=2){let[e,o]=c.slice(t,t+2);h||(e+=s,o+=r),u.push(e,o)}break;case"Q":case"S":for(let t=0,e=c.length;t<e;t+=4){let[e,o,n,a]=c.slice(t,t+4);h||(e+=s,o+=r,n+=s,a+=r),u.push(e,o,n,a)}break;case"Z":c[0]="",n=""}o+=i.cmd+u.join(",")+n}return o}catch(t){a("Path parsing error: "+t)}},de=t=>{const{path:e,localCTM:s}=t;try{const t=he(e);let r="",o=" ";const n=[];let a=!0;for(let e=0,i=t.length;e<i;e++){const i=t[e],{values:c,key:l,relative:h}=i;switch(l){case"A":{const t=[];for(let e=0,r=c.length;e<r;e+=7){const[r,o,n,a,i,l,u]=c.slice(e,e+7),d=ne(s);h&&(d.e=d.f=0);const{x:p,y:x}=oe(d,l,u);t.push(j(p),j(x)),d.e=d.f=0;const{x:f,y:y}=oe(d,r,o);t.unshift(j(f),j(y),n,a,i)}n.push(t);break}case"C":{const t=[];for(let e=0,r=c.length;e<r;e+=6){const[r,o,n,a,i,l]=c.slice(e,e+6),u=ne(s);h&&(u.e=u.f=0);const{x:d,y:p}=oe(u,r,o),{x:x,y:f}=oe(u,n,a),{x:y,y:b}=oe(u,i,l);t.push(j(d),j(p),j(x),j(f),j(y),j(b))}n.push(t);break}case"H":{const t=[];for(let e=0,r=c.length;e<r;e+=1){const[r]=c.slice(e,e+1),o=ne(s);h&&(o.e=o.f=0);const{x:n}=oe(o,r,0);t.push(j(n))}n.push(t);break}case"V":{const t=[];for(let e=0,r=c.length;e<r;e+=1){const[r]=c.slice(e,e+1),o=ne(s);h&&(o.e=o.f=0);const{y:n}=oe(o,0,r);t.push(j(n))}n.push(t);break}case"T":case"L":{const t=[];for(let e=0,r=c.length;e<r;e+=2){const[r,o]=c.slice(e,e+2),n=ne(s);h&&(n.e=n.f=0);const{x:a,y:i}=oe(n,r,o);t.push(j(a),j(i))}n.push(t);break}case"M":{const t=[];for(let e=0,r=c.length;e<r;e+=2){const[r,o]=c.slice(e,e+2),n=ne(s);h&&!a&&(n.e=n.f=0);const{x:i,y:l}=oe(n,r,o);t.push(j(i),j(l)),a=!1}n.push(t);break}case"Q":{const t=[];for(let e=0,r=c.length;e<r;e+=4){const[r,o,n,a]=c.slice(e,e+4),i=ne(s);h&&(i.e=i.f=0);const{x:l,y:u}=oe(i,r,o),{x:d,y:p}=oe(i,n,a);t.push(j(l),j(u),j(d),j(p))}n.push(t);break}case"S":{const t=[];for(let e=0,r=c.length;e<r;e+=4){const[r,o,n,a]=c.slice(e,e+4),i=ne(s);h&&(i.e=i.f=0);const{x:l,y:u}=oe(i,r,o),{x:d,y:p}=oe(i,n,a);t.push(j(l),j(u),j(d),j(p))}n.push(t);break}case"Z":n.push([""]),o=""}r+=i.cmd+n[e].join(",")+o}return r}catch(t){a("Path parsing error: "+t)}},{E_DRAG:pe,E_RESIZE:xe}=y,{E_MOUSEDOWN:fe,E_TOUCHSTART:ye}=b;class be extends wt{_init(t){const{rotationPoint:e,container:s,controlsContainer:r,resizable:o,rotatable:n,rotatorAnchor:a,rotatorOffset:h,showNormal:u,custom:d}=this.options,x=t.getBBox(),{x:f,y:y,width:b,height:m}=x,_=Qt("g",["sjx-svg-wrapper"]),g=Qt("g",["sjx-svg-controls"]),E=["data-sjx-cx","data-sjx-cy"].map(e=>{const s=t.getAttribute(e);return i(s)?Number(s):void 0}),v=E.every(t=>!isNaN(t)),M={tl:[f,y],tr:[f+b,y],mr:[f+b,y+m/2],ml:[f,y+m/2],tc:[f+b/2,y],bc:[f+b/2,y+m],br:[f+b,y+m],bl:[f,y+m],center:[f+b/2,y+m/2]},T=se(t,s),w=Object.entries(M).reduce((t,[e,[s,r]])=>({...t,[e]:oe(T,s,r)}),{}),O={};let S={},R=null;if(n){const t={};let s=1;switch(a){case"n":t.x=w.tc.x,t.y=w.tc.y;break;case"s":t.x=w.bc.x,t.y=w.bc.y,s=-1;break;case"w":t.x=w.ml.x,t.y=w.ml.y,s=-1;break;case"e":default:t.x=w.mr.x,t.y=w.mr.y}const r="n"===a||"s"===a?Math.atan2(w.bl.y-w.tl.y,w.bl.x-w.tl.x):Math.atan2(w.tl.y-w.tr.y,w.tl.x-w.tr.x);R={x:t.x-h*s*Math.cos(r),y:t.y-h*s*Math.sin(r)};const o=u?Te([t,R],"#00a8ff","normal"):null;u&&g.appendChild(o);let n=null;e&&(n=Qt("line",["sjx-hidden"]),n.x1.baseVal.value=w.center.x,n.y1.baseVal.value=w.center.y,n.x2.baseVal.value=E[0]||w.center.x,n.y2.baseVal.value=E[1]||w.center.y,ve(n,"#fe3232"),n.setAttribute("opacity",.5),g.appendChild(n)),S={...S,normal:o,radius:n}}const N=o?{tl:w.tl,tr:w.tr,br:w.br,bl:w.bl,tc:w.tc,bc:w.bc,ml:w.ml,mr:w.mr}:{},A={te:[w.tl,w.tr],be:[w.bl,w.br],le:[w.tl,w.bl],re:[w.tr,w.br]};Object.keys(A).forEach(t=>{const e=A[t];c(e)||(O[t]=Te(e,"#00a8ff",t),g.appendChild(O[t]))});const k=v?oe(te(),E[0],E[1]):w.center,D={...N,rotator:R,center:e&&n?k:void 0};Object.keys(D).forEach(t=>{const e=D[t];if(c(e))return;const{x:s,y:r}=e,o="center"===t?"#fe3232":"#00a8ff";i(d)&&l(d[t])?O[t]=d[t](T,x,oe):O[t]=Ee(s,r,o,t),g.appendChild(O[t])}),_.appendChild(g),r.appendChild(_),this.storage={wrapper:_,controls:g,handles:{...O,...S},parent:t.parentNode,center:{isShifted:v},cached:{}},[t,g].map(t=>p(t).on(fe,this._onMouseDown).on(ye,this._onTouchStart))}_cursorPoint({clientX:t,clientY:e}){const{container:s}=this.options;return this._applyMatrixToPoint(s.getScreenCTM().inverse(),t,e)}_restrictHandler(t){const{storage:{transform:{containerMatrix:e}},options:{container:s,restrict:r=s}}=this;let o=null,n=null;const a=we(r,e),i=this.getBoundingRect(t),[c,l]=P(a,0),[h,u]=P(a,1);for(let t=0,e=i.length;t<e;t++){const[e,s]=i[t];(e<c||e>l)&&(o=e),(s<h||s>u)&&(n=s)}return{x:o,y:n}}_pointToElement({x:t,y:e}){const{transform:{ctm:s}}=this.storage,r=s.inverse();return r.e=r.f=0,this._applyMatrixToPoint(r,t,e)}_pointToControls({x:t,y:e}){const{transform:{wrapperMatrix:s}}=this.storage,r=s.inverse();return r.e=r.f=0,this._applyMatrixToPoint(r,t,e)}_applyMatrixToPoint(t,e,s){const r=Qt("svg").createSVGPoint();return r.x=e,r.y=s,r.matrixTransform(t)}_apply(t){const{el:e,storage:s,storage:{bBox:r,cached:o,transform:n,center:a},options:i,options:{container:l,scalable:h,applyTranslate:u}}=this,{matrix:d,parentMatrix:p,ctm:x}=n;if(e.setAttribute("data-sjx-cx",a.elX),e.setAttribute("data-sjx-cy",a.elY),c(o))return;const{scaleX:f,scaleY:y,dx:b,dy:m,ox:_,oy:g,transformMatrix:E}=o;if(t===pe){if(!u||0===b&&0===m)return;const t=ee(b,m),s=t.multiply(d).multiply(t.inverse());if(e.setAttribute("transform",re(s)),ae(e)){Jt(e).forEach(t=>{const e=ee(b,m),s=e.multiply(se(t,t.parentNode)).multiply(e.inverse());if((t=>{const{a:e,b:s,c:r,d:o,e:n,f:a}=t;return 1===e&&0===s&&0===r&&1===o&&0===n&&0===a})(s)||t.setAttribute("transform",re(s)),!ae(t)){const e=p.inverse();e.e=e.f=0,me(t,{...oe(e,_,g)})}})}else me(e,{x:b,y:m})}if(t===xe){if(!E)return;if(!h)if(ae(e)){Jt(e).forEach(t=>{if(!ae(t)){const n=se(t,e),a=n.inverse().multiply(E).multiply(n);_e(t,{scaleX:f,scaleY:y,localCTM:a,bBox:r,container:l,storage:s,cached:o})}})}else{const t=l.getScreenCTM()||te(),n=e.getScreenCTM().multiply(E),a=t.inverse().multiply(n),i=x.inverse().multiply(a);_e(e,{scaleX:f,scaleY:y,localCTM:i,bBox:r,container:l,storage:s,cached:o})}ge(s,i,{boxMatrix:h?x.multiply(E):x,element:e})}}_processResize(t,e){const{el:s,storage:r,storage:{bBox:{width:o,height:n},revX:a,revY:i,doW:c,doH:l,transform:{matrix:h,auxiliary:{scale:{translateMatrix:u}}},cached:{dist:{dx:d=t,dy:p=e}={}}={}},options:{proportions:x,scalable:f,restrict:y}}=this,{x:b,y:m}=s.getBBox(),_=(t,e)=>{const s=c||!c&&!l?(o+t)/o:(n+e)/n,r=x?o*s:o+t,a=x?n*s:n+e;return[r/o,a/n,r,a]},g=(t,e)=>{const s=((t,e)=>{const s=te();return s.a=t,s.d=e,s})(t,e);return u.multiply(s).multiply(u.inverse())},E=h.multiply(g(..._(t,e))),{x:v,y:M}=y?this._restrictHandler(E):{x:null,y:null},T=(null!==v||null!==M)&&y,w=T?d:t,O=T?p:e,[S,R,N,A]=_(w,O);if(Math.abs(N)<=2||Math.abs(A)<=2)return;const k=g(S,R),D=h.multiply(k),V=b-(N-o)*(l?.5:a?1:0),C=m-(A-n)*(c?.5:i?1:0);return f&&s.setAttribute("transform",re(D)),r.cached={...r.cached,scaleX:S,scaleY:R,transformMatrix:k,resultMatrix:D,dist:{dx:w,dy:O}},this._apply(xe),{x:V,y:C,width:N,height:A,transform:D}}_processMove(t,e){const{storage:s,storage:{wrapper:r,center:o,transform:{matrix:n,auxiliary:{translate:{translateMatrix:a,wrapperTranslateMatrix:i}},wrapperMatrix:c,parentMatrix:l},cached:{dist:{dx:h=t,dy:u=e}={}}={}},options:{restrict:d}}=this;l.e=l.f=0;const{x:p,y:x}=oe(l.inverse(),t,e),f=ee(p,x).multiply(n),{x:y,y:b}=d?this._restrictHandler(f):{x:null,y:null},m=null!==y&&d?h:t,_=null!==b&&d?u:e;s.cached.dist={dx:m,dy:_};const{x:g,y:E}=oe(l.inverse(),m,_);a.e=g,a.f=E;const v=a.multiply(n);i.e=m,i.f=_;const M=i.multiply(c);if(r.setAttribute("transform",re(M)),this.el.setAttribute("transform",re(v)),o.isShifted){const t=c.inverse();t.e=t.f=0;const{x:e,y:s}=oe(t,m,_);this._moveCenterHandle(-e,-s)}return v}_processRotate(t){const{storage:{wrapper:e,transform:{matrix:s,wrapperMatrix:r,parentMatrix:o,auxiliary:{rotate:{translateMatrix:n,wrapperTranslateMatrix:a}}}},options:{restrict:c}}=this,l=j(Math.cos(t)),h=((t,e)=>{const s=te();return s.a=e,s.b=t,s.c=-t,s.d=e,s})(j(Math.sin(t)),l);o.e=o.f=0;const u=o.inverse().multiply(h).multiply(o),d=n.multiply(u).multiply(n.inverse()).multiply(s),{x:p,y:x}=c?this._restrictHandler(d):{x:null,y:null};if(i(p)||i(x))return d;const f=a.multiply(h).multiply(a.inverse()).multiply(r);return e.setAttribute("transform",re(f)),this.el.setAttribute("transform",re(d)),d}_getState({revX:t,revY:e,doW:s,doH:r}){const{el:o,storage:{wrapper:n,parent:a,handles:{center:i}},options:{container:c,restrict:l}}=this,h=o.getBBox(),{x:u,y:d,width:p,height:x}=h,f=se(o,a),y=se(o,c),b=se(n,c),m=se(a,c),_=se(n,n.parentNode),g=m.inverse(),E=u+p*(r?.5:t?1:0),v=d+x*(s?.5:e?1:0),M=u+p/2,T=d+x/2,w=i?i.cx.baseVal.value:M,O=i?i.cy.baseVal.value:T,{x:S,y:R}=oe(b,w,O),{x:N,y:A}=i?oe(g,S,R):oe(f,M,T),{x:k,y:D}=oe(y,M,T);Me(this.el),Jt(o).forEach(t=>{t.__ctm__=se(t,t.parentNode),Me(t)});const V={...this.storage.center||{},x:i?S:k,y:i?R:D,elX:N,elY:A,hx:i?i.cx.baseVal.value:null,hy:i?i.cy.baseVal.value:null},C=l?se(l,l.parentNode):se(c,c.parentNode);return{transform:{auxiliary:{scale:{scaleMatrix:te(),translateMatrix:ee(E,v)},translate:{parentMatrix:g,translateMatrix:te(),wrapperTranslateMatrix:te()},rotate:{translateMatrix:ee(V.elX,V.elY),wrapperTranslateMatrix:ee(V.x,V.y)}},matrix:f,ctm:y,parentMatrix:m,wrapperMatrix:_,containerMatrix:C,scX:Math.sqrt(y.a*y.a+y.b*y.b),scY:Math.sqrt(y.c*y.c+y.d*y.d)},bBox:h,center:V,revX:t,revY:e,doW:s,doH:r}}_moveCenterHandle(t,e){const{handles:{center:s,radius:r},center:{hx:o,hy:n}}=this.storage;if(c(s))return;const a=o+t,i=n+e;s.cx.baseVal.value=a,s.cy.baseVal.value=i,r.x2.baseVal.value=a,r.y2.baseVal.value=i,this.storage.center.isShifted=!0}resetCenterPoint(){const{el:t,storage:{bBox:{width:e,height:s,x:r,y:o},handles:{center:n,radius:a}}}=this;if(!n)return;const i=se(t,t.parentNode),{x:c,y:l}=oe(i,r+e/2,o+s/2);n.cx.baseVal.value=c,n.cy.baseVal.value=l,n.isShifted=!1,a.x2.baseVal.value=c,a.y2.baseVal.value=l}fitControlsToSize(){const{el:t,storage:{wrapper:e},options:{container:s}}=this,{width:r,height:o,x:n,y:a}=t.getBBox(),i=se(t,s),c=te();this.storage.transform.wrapperMatrix=c,e.setAttribute("transform",re(c)),ge(this.storage,this.options,{x:n,y:a,width:r,height:o,boxMatrix:i,element:t})}getBoundingRect(t){const{el:e,options:{restrict:s},storage:{bBox:r}}=this;return we(e,se(e.parentNode,s).multiply(t),r)}get controls(){return this.storage.wrapper}}const me=(t,{x:e,y:s})=>{const r=[];switch(t.tagName.toLowerCase()){case"text":{const o=i(t.x.baseVal[0])?t.x.baseVal[0].value+e:(Number(t.getAttribute("x"))||0)+e,n=i(t.y.baseVal[0])?t.y.baseVal[0].value+s:(Number(t.getAttribute("y"))||0)+s;r.push(["x",o],["y",n]);break}case"foreignobject":case"use":case"image":case"rect":{const o=i(t.x.baseVal.value)?t.x.baseVal.value+e:(Number(t.getAttribute("x"))||0)+e,n=i(t.y.baseVal.value)?t.y.baseVal.value+s:(Number(t.getAttribute("y"))||0)+s;r.push(["x",o],["y",n]);break}case"circle":case"ellipse":{const o=t.cx.baseVal.value+e,n=t.cy.baseVal.value+s;r.push(["cx",o],["cy",n]);break}case"line":{const o=t.x1.baseVal.value+e,n=t.y1.baseVal.value+s,a=t.x2.baseVal.value+e,i=t.y2.baseVal.value+s;r.push(["x1",o],["y1",n],["x2",a],["y2",i]);break}case"polygon":case"polyline":{const o=ce(t.getAttribute("points")).map(t=>(t[0]=Number(t[0])+e,t[1]=Number(t[1])+s,t.join(" "))).join(" ");r.push(["points",o]);break}case"path":{const o=t.getAttribute("d");r.push(["d",ue({path:o,dx:e,dy:s})]);break}}r.forEach(e=>{t.setAttribute(e[0],e[1])})},_e=(t,e)=>{const{scaleX:s,scaleY:r,localCTM:o,bBox:{width:n,height:a}}=e,i=[];switch(t.tagName.toLowerCase()){case"text":case"tspan":{const{x:e,y:c,textLength:l}=t.__data__,{x:h,y:u}=oe(o,e,c);i.push(["x",h+(s<0?n:0)],["y",u-(r<0?a:0)],["textLength",Math.abs(s*l)]);break}case"circle":{const{r:e,cx:n,cy:a}=t.__data__,c=e*(Math.abs(s)+Math.abs(r))/2,{x:l,y:h}=oe(o,n,a);i.push(["r",c],["cx",l],["cy",h]);break}case"foreignobject":case"image":case"rect":{const{width:e,height:n,x:a,y:c}=t.__data__,{x:l,y:h}=oe(o,a,c),u=Math.abs(e*s),d=Math.abs(n*r);i.push(["x",l-(s<0?u:0)],["y",h-(r<0?d:0)],["width",u],["height",d]);break}case"ellipse":{const{rx:e,ry:n,cx:a,cy:c}=t.__data__,{x:l,y:h}=oe(o,a,c),u=te();u.a=s,u.d=r;const{x:d,y:p}=oe(u,e,n);i.push(["rx",Math.abs(d)],["ry",Math.abs(p)],["cx",l],["cy",h]);break}case"line":{const{resX1:e,resY1:s,resX2:r,resY2:n}=t.__data__,{x:a,y:c}=oe(o,e,s),{x:l,y:h}=oe(o,r,n);i.push(["x1",a],["y1",c],["x2",l],["y2",h]);break}case"polygon":case"polyline":{const{points:e}=t.__data__,s=ce(e).map(t=>{const{x:e,y:s}=oe(o,Number(t[0]),Number(t[1]));return t[0]=j(e),t[1]=j(s),t.join(" ")}).join(" ");i.push(["points",s]);break}case"path":{const{path:e}=t.__data__;i.push(["d",de({path:e,localCTM:o})]);break}}i.forEach(([e,s])=>{t.setAttribute(e,s)})},ge=(t,e,s)=>{const{rotatable:r,rotatorAnchor:o,rotatorOffset:n}=e,{wrapper:a,handles:l,center:h,transform:{wrapperMatrix:u=se(a,a.parentNode)}={}}=t;let{boxMatrix:d,element:p}=s;const{x:x,y:f,width:y,height:b}=p.getBBox(),m=y/2,_=b/2,g=u.inverse().multiply(d),E=oe(g,x+m,f+_),v={tl:[x,f],tr:[x+y,f],mr:[x+y,f+_],ml:[x,f+_],tc:[x+m,f],bc:[x+m,f+b],br:[x+y,f+b],bl:[x,f+b],...!h.isShifted&&{center:[x+m,f+_]}},M=Object.entries(v).reduce((t,[e,s])=>(t[e]=oe(g,s[0],s[1]),t),{}),T={te:[M.tl,M.tr],be:[M.bl,M.br],le:[M.tl,M.bl],re:[M.tr,M.br]};if(r){const t={};let e=1;switch(o){case"n":t.x=M.tc.x,t.y=M.tc.y;break;case"s":t.x=M.bc.x,t.y=M.bc.y,e=-1;break;case"w":t.x=M.ml.x,t.y=M.ml.y,e=-1;break;case"e":default:t.x=M.mr.x,t.y=M.mr.y}const s="n"===o||"s"===o?Math.atan2(M.bl.y-M.tl.y,M.bl.x-M.tl.x):Math.atan2(M.tl.y-M.tr.y,M.tl.x-M.tr.x),r=n*e,a={x:t.x-r*Math.cos(s),y:t.y-r*Math.sin(s)},{normal:c,radius:u}=l;i(c)&&(c.x1.baseVal.value=t.x,c.y1.baseVal.value=t.y,c.x2.baseVal.value=a.x,c.y2.baseVal.value=a.y),i(u)&&(u.x1.baseVal.value=E.x,u.y1.baseVal.value=E.y,h.isShifted||(u.x2.baseVal.value=E.x,u.y2.baseVal.value=E.y)),M.rotator=a}Object.keys(T).forEach(t=>{const e=l[t],[s,r]=T[t];c(s)||c(e)||Object.entries({x1:s.x,y1:s.y,x2:r.x,y2:r.y}).map(([t,s])=>e.setAttribute(t,s))}),Object.keys(M).forEach(t=>{const e=l[t],s=M[t];c(s)||c(e)||(e.setAttribute("cx",s.x),e.setAttribute("cy",s.y))})},Ee=(t,e,s,r)=>{const o=Qt("circle",["sjx-svg-hdl","sjx-svg-hdl-"+r]),n={cx:t,cy:e,r:4,fill:"#fff",stroke:s,"stroke-width":1,"fill-opacity":1,"vector-effect":"non-scaling-stroke"};return Object.entries(n).forEach(([t,e])=>o.setAttribute(t,e)),o},ve=(t,e)=>{t.setAttribute("stroke",e),t.setAttribute("stroke-dasharray","3 3"),t.setAttribute("vector-effect","non-scaling-stroke")},Me=t=>{switch(t.tagName.toLowerCase()){case"text":{const e=i(t.x.baseVal[0])?t.x.baseVal[0].value:Number(t.getAttribute("x"))||0,s=i(t.y.baseVal[0])?t.y.baseVal[0].value:Number(t.getAttribute("y"))||0,r=i(t.textLength.baseVal)?t.textLength.baseVal.value:Number(t.getAttribute("textLength"))||null;t.__data__={x:e,y:s,textLength:r};break}case"circle":{const e=t.r.baseVal.value,s=t.cx.baseVal.value,r=t.cy.baseVal.value;t.__data__={r:e,cx:s,cy:r};break}case"foreignobject":case"image":case"rect":{const e=t.width.baseVal.value,s=t.height.baseVal.value,r=t.x.baseVal.value,o=t.y.baseVal.value;t.__data__={width:e,height:s,x:r,y:o};break}case"ellipse":{const e=t.rx.baseVal.value,s=t.ry.baseVal.value,r=t.cx.baseVal.value,o=t.cy.baseVal.value;t.__data__={rx:e,ry:s,cx:r,cy:o};break}case"line":{const e=t.x1.baseVal.value,s=t.y1.baseVal.value,r=t.x2.baseVal.value,o=t.y2.baseVal.value;t.__data__={resX1:e,resY1:s,resX2:r,resY2:o};break}case"polygon":case"polyline":{const e=t.getAttribute("points");t.__data__={points:e};break}case"path":{const e=t.getAttribute("d");t.__data__={path:e};break}}},Te=([t,e],s,r)=>{const o=Qt("line",["sjx-svg-line","sjx-svg-line-"+r]),n={x1:t.x,y1:t.y,x2:e.x,y2:e.y,stroke:s,"stroke-width":1,"vector-effect":"non-scaling-stroke"};return Object.entries(n).forEach(([t,e])=>o.setAttribute(t,e)),o},we=(t,e,s=t.getBBox())=>{const{x:r,y:o,width:n,height:a}=s;return[[r,o],[r+n,o],[r+n,o+a],[r,o+a]].map(([t,s])=>{const{x:r,y:o}=oe(e,t,s);return[r,o]})};function Oe(t,e){if(this.length){const s=i(e)&&e instanceof T?e:new T;return n.call(this,(e,r)=>(r instanceof SVGElement?(t=>{const e=t.tagName.toLowerCase();return-1!==Kt.indexOf(e)||(a(`Selected element "${e}" is not allowed to transform. Allowed elements:\n\n            circle, ellipse, image, line, path, polygon, polyline, rect, text, g`),!1)})(r)&&e.push(new be(r,t,s)):e.push(new It(r,t,s)),e),[])}}const{EMITTER_EVENTS:Se}=y,{E_MOUSEDOWN:Re,E_TOUCHSTART:Ne}=b;class Ae extends D{constructor(t,e){super(t),this.enable(e)}_init(){const{el:t,options:e}=this,s=p(t),{style:r,appendTo:o}=e,n={position:"absolute","z-index":"2147483647",...r};this.storage={css:n,parent:i(o)?p(o)[0]:document.body},s.on(Re,this._onMouseDown).on(Ne,this._onTouchStart),Se.slice(0,3).forEach(t=>{this.eventDispatcher.registerEvent(t)})}_processOptions(t){let e={},s=null,r=document,o=()=>{},n=()=>{},a=()=>{},c=()=>{};if(i(t)){const{style:r,appendTo:u,stack:d,onInit:x,onMove:f,onDrop:y,onDestroy:b}=t;e=i(r)&&"object"==typeof r?r:e,s=u||null;const m=i(d)?p(d)[0]:document;o=h(x),n=h(f),a=l(y)?function(t){const{clone:e}=this.storage;((t,e)=>{const{top:s,left:r}=X(t),{top:o,left:n}=X(e),a=p(t),i=p(e);return!(s<o||s+parseFloat(a.css("height"))>o+parseFloat(i.css("height"))||r<n||r+parseFloat(a.css("width"))>n+parseFloat(i.css("width")))})(e,m)&&y.call(this,t,this.el,e)}:()=>{},c=h(b)}this.options={style:e,appendTo:s,stack:r},this.proxyMethods={onInit:o,onDrop:a,onMove:n,onDestroy:c}}_start({clientX:t,clientY:e}){const{storage:s,el:r}=this,{parent:o,css:n}=s,{left:a,top:i}=X(o);n.left=t-a+"px",n.top=e-i+"px";const c=r.cloneNode(!0);p(c).css(n),s.clientX=t,s.clientY=e,s.cx=t,s.cy=e,s.clone=c,p(o)[0].appendChild(c),this._draw()}_moving({clientX:t,clientY:e}){const{storage:s}=this;s.clientX=t,s.clientY=e,s.doDraw=!0,s.doMove=!0}_end(t){const{storage:s}=this,{clone:r,frameId:o}=s;s.doDraw=!1,e(o),c(r)||(this.proxyMethods.onDrop.call(this,t),r.parentNode.removeChild(r),delete s.clone)}_animate(){const{storage:e}=this;e.frameId=t(this._animate);const{doDraw:s,clientX:r,clientY:o,cx:n,cy:a}=e;s&&(e.doDraw=!1,this._drag({dx:r-n,dy:o-a}))}_processMove(t,e){const{clone:s}=this.storage,r=`translate(${t}px, ${e}px)`;p(s).css({transform:r,webkitTranform:r,mozTransform:r,msTransform:r,otransform:r})}_destroy(){const{storage:t,proxyMethods:e,el:s}=this;c(t)||(p(s).off(Re,this._onMouseDown).off(Ne,this._onTouchStart),e.onDestroy.call(this,s),delete this.storage)}disable(){this._destroy()}}function ke(t){if(this.length)return o.call(this,e=>new Ae(e,t))}class De extends u{drag(){return Oe.call(this,...arguments)}clone(){return ke.call(this,...arguments)}}function Ve(t){return new De(t)}Object.defineProperty(Ve,"createObservable",{value:()=>new T}),Object.defineProperty(Ve,"Subjx",{value:De}),Object.defineProperty(Ve,"Observable",{value:T}),module.exports=Ve;
